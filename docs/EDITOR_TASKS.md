# エディタ機能 仕様・設計・タスク分解

## 目的
- クイックにシーン/選択肢を挿入しつつ、最終サイト表示に近いプレビューを提供。
- 将来の拡張（文字装飾/アニメーション、変数管理、拡張テンプレート）に耐える疎結合・単一責務の構成。

## 設計方針
- 単一責務: スクリプトは 200 行前後を目安に分割。
  - `static/js/editor.js`: Quill ラッパ（初期化、挿入、表示/内容モード、同期）。
  - `static/js/markdown-converter.js`: Markdown → HTML（marked + DOMPurify）。
  - `static/js/scenario-editor.js`: サイドバー、フィルタ、フォーム描画などページ固有ロジック（ESM）。
  - `static/js/commonUI.js` 等: UI 汎用部品。
- グローバル名前空間 `window.NovelGenPage` を最低限に限定（`editor` のみ）。
- DOM は ID/クラスの互換を維持して後方互換（`#insert-*`, `.insert-*-btn`, `.ql-insert-*`）。
- キャッシュ対策: `<script src="...?.v=X.Y.Z">` を採用。

## 現状の実装要点（抜粋）
- `SimpleEditor.insertScene()/insertChoice()` によりスニペット挿入とプレビュー更新を実装。
- marked の API 差異（関数/`parse`）両対応、例外時は簡易変換にフォールバック。
- ビュー切替（split/editor/preview/zen）と内容モード（visual/raw）を提供。
- 旧ツールバークラス/未配置トグルに対する実行時サニタイズ/生成を実装。

## 追加機能タスク
- 文字アニメ/装飾テンプレート
  - [ ] `static/js/text-effects.js`（装飾プリセット、適用 API）
  - [ ] プレビューでの CSS/JS 再現（サイト本番に近い）
- 変数/プロパティ管理
  - [ ] ゲーム変数（アイテム/フラグ）編集 UI（フォーム分離）
  - [ ] 保存/検証 API 連携
- 選択肢/シーンの拡張
  - [ ] スニペットテンプレートの差し替え設定（データ属性 or 設定画面）
  - [ ] 生成時のナンバリングと重複チェック
- テスト強化
  - [ ] Jest/JSdom でのユニットテスト（markdown 変換、挿入関数）
  - [ ] E2E（後日、Playwright など）

## 期待される最終状態
- エディタからワンクリックでシーン/選択肢が正しく挿入され、プレビューに即反映。
- マークダウン変換の例外や API 差異で壊れない。
- 表示モード/内容モード/Zen の切替が安定し、UI が一貫して動作。
- 将来の装飾/変数管理/テンプレート拡張が既存コードと独立に追加可能。

## テスト
- `TESTING.md` の回帰手順に従い、挿入・変換・表示切替・キャッシュ対策を確認。
- CI（将来）で Jest を実行し、主要ユースケースの回帰を担保。
